#!/bin/bash

# clean_old_logs.sh
# Скрипт для поиска и удаления старых лог-файлов (.log) старше N дней


########################################
# Функция: вывод справки
########################################
show_help() {
    echo "Использование: $0 <путь_к_директории> <количество_дней>"
    echo
    echo "Аргументы:"
    echo "  <путь_к_директории>  — путь к директории с логами (например, /var/log/myapp)"
    echo "  <количество_дней>   — возраст файлов в днях (файлы старше этого срока будут удалены)"
    echo
    echo "Пример:"
    echo "  $0 /var/log/myapp 30"
    echo
    echo "Скрипт:"
    echo "  1. Найдёт все файлы *.log в указанной директории, старше N дней."
    echo "  2. Выведет список найденных файлов."
    echo "  3. Запросит подтверждение на удаление."
    echo "  4. При ответе 'y' — удалит файлы, при 'n' — завершит работу."
}

########################################
# Проверка аргументов
########################################
if [ $# -ne 2 ]; then
    echo "Ошибка: передано некорректное количество аргументов."
    show_help
    exit 1
fi

LOG_DIR="$1"
DAYS="$2"

# Проверка, что директория существует
if [ ! -d "$LOG_DIR" ]; then
    echo "Ошибка: директория '$LOG_DIR' не существует или недоступна."
    exit 1
fi

# Проверка, что DAYS — число
if ! [[ "$DAYS" =~ ^[0-9]+$ ]]; then
    echo "Ошибка: количество дней должно быть положительным числом."
    exit 1
fi

########################################
# Поиск файлов
########################################
echo "Поиск файлов *.log в директории '$LOG_DIR', старше $DAYS дней..."

# Находим файлы, сохраняем в массив
mapfile -t log_files < <(find "$LOG_DIR" -type f -name "*.log" -mtime +"$DAYS" 2>/dev/null)

# Если файлов не найдено
if [ ${#log_files[@]} -eq 0 ]; then
    echo "Файлы *.log старше $DAYS дней не найдены."
    exit 0
fi

# Выводим список найденных файлов
echo
echo "Найденные файлы:"
for file in "${log_files[@]}"; do
    echo "  $file"
done

echo

########################################
# Запрос подтверждения
########################################
read -p "Удалить эти файлы? (y/n): " confirm

if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
    echo "Удаление отменено."
    exit 0
fi

########################################
# Удаление файлов
########################################
echo
echo "Удаление файлов..."
for file in "${log_files[@]}"; do
    if rm -f "$file"; then
        echo "Удалено: $file"
    else
        echo "Ошибка при удалении: $file"
    fi
done

echo
echo "Готово."
exit 0
